#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Fri Nov 18 12:41:19 2016

@author: JonKyle
"""
import os
import csv
from PEFile import PE32
from tkinter import *
from tkinter import ttk
from tkinter.filedialog import askdirectory
from numpy import genfromtxt
import numpy as np
from sklearn.decomposition import PCA
from sklearn.decomposition import NMF
from sklearn.cluster import KMeans
from sklearn.cluster import MeanShift
import pylab as pl

directory = os.curdir

def HexToDec(hexString):
    return int(hexString, base=16)
    
def setBinaryPath():
    global directory
    directory = askdirectory()
    label.config(text ='Directory: '+ directory)
    
def getBinaryPath():
    return directory
    
def extractFeaturesToCsv():
    with open('features.csv', 'w') as csvfile:  
        writer = csv.writer(csvfile, quoting=csv.QUOTE_NONE)
        fieldnames = [ 'Section1Entropy','Section2Entropy','Section3Entropy','Section4Entropy','FileEntropy','CodeDataRatio']
        writer.writerow(fieldnames)
        
        for filename in os.listdir(directory):
            if filename.endswith(".dll") or filename.endswith('.exe'):
                with open(directory+'/'+filename,"rb") as bufferedReader:
                    peFile= PE32()
                    peFile.File(bufferedReader,directory+'/'+filename)
                    
                    sectionEntropy = [0] * peFile.GetNumberOfSections()
                    
                    for index in range(peFile.GetNumberOfSections()):
                        Offset = peFile.GetSectionPointerToRawData(index)
                        Length = peFile.GetSectionSizeOfRawData(index)
                        Entropy = peFile.CalculateEntropy(HexToDec(Offset),HexToDec(Length))
                        sectionEntropy[index] = Entropy
    
                    FileEntropy = peFile.GetFileEntropy()
                    IATRVA= peFile.GetIATRVA()
                    ExportTableSize= peFile.GetExportTableSize()
                    ResourceTableSize= peFile.GetResourceTableSize()
                    CodeDataRatio = peFile.GetCodeDataRatio()
                    
                    row = [0] * 6
                    
                    for i in range(4):
                        if i >= peFile.GetNumberOfSections():
                            row[i] = 0
                        else:
                            row[i] = sectionEntropy[i]
    
                    row[4] = FileEntropy
                    row[5] = CodeDataRatio
    
                    
                    writer.writerow(row)
                    
                    listbox.insert(END,filename)
                    listbox.update_idletasks()
                    
def read():
    global my_data
    my_data = genfromtxt('features.csv', delimiter=',')
    for row in my_data[1:]:
        print(row)
        
def doPca():
   global X
   pca = PCA(n_components=2)
   pca.fit(my_data[1:])
   PCA(copy=True, n_components=2, whiten=False)
   X = pca.transform(my_data[1:])
   pl.scatter(X[:, 0], X[:, 1])
   pl.show()
   
   
def doNmf():
   global X
   nmf = NMF(n_components=2)
   nmf.fit(my_data[1:])
   PCA(copy=True, n_components=2, whiten=False)
   X = nmf.transform(my_data[1:])
   pl.scatter(X[:, 0], X[:, 1])
   pl.show()
   
def doMeanShift():
    ms = MeanShift()
    ms.fit(X)
    labels = ms.labels_
    colors = ["g.","r.","c.","y."]
    cluster_centers = ms.cluster_centers_
    for i in range(len(X)):
        pl.plot(X[i][0], X[i][1], colors[labels[i]], markersize = 10)
    pl.scatter(cluster_centers[:,0],cluster_centers[:,1],
            marker="x",color='k', s=150, linewidths = 5, zorder=10)

    pl.show()

def doKMeans():
    km = KMeans(n_clusters=3)
    km.fit(X)
    labels = km.labels_
    colors = ["g.","r.","c.","y."]
    cluster_centers = km.cluster_centers_
    for i in range(len(X)):
        pl.plot(X[i][0], X[i][1], colors[labels[i]], markersize = 10)
    pl.scatter(cluster_centers[:,0],cluster_centers[:,1],
            marker="x",color='k', s=150, linewidths = 5, zorder=10)

    pl.show()

top = Tk()
top.geometry('1200x800')
top.title("PE Parser")

browse = Button(top, text="Browse to binary directory", command=setBinaryPath)
browse.grid(row =0, column=1)

label = Label(top, text = getBinaryPath())
label.grid(row =1, column=1)



extract = Button(top, text="Extract Features To CSV", command=lambda: extractFeaturesToCsv())
extract.grid(row =0, column=2, sticky=E)

readB = Button(top, text="Read from csv", command=lambda: read())
readB.grid(row =0, column=3, sticky=E)

PCAB = Button(top, text="PCA", command=lambda: doPca())
PCAB.grid(row =0, column=4, sticky=E)

msB = Button(top, text="Mean Shift", command=lambda: doMeanShift())
msB.grid(row =0, column=5, sticky=E)

kmB = Button(top, text="KMeans", command=lambda: doKMeans())
kmB.grid(row =0, column=6, sticky=E)

nmB = Button(top, text="NMF", command=lambda: doNmf())
nmB.grid(row =0, column=7, sticky=E)

listbox = Listbox(top, height =50)
listbox.grid(column=0)



top.mainloop()


